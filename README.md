# ROS2 Bag to KITTI Dataset Conversion

This package provides two Python scripts to convert ROS2 bag files containing PointCloud2 and Marker messages into KITTI dataset format, suitable for deep learning-based 3D detection pipelines such as PointPillars.

## Features

- Extract and convert sensor_msgs/PointCloud2 topics from ROS2 bag files to KITTI Velodyne .bin files
- Extract and convert bounding box visualization_msgs/Marker topics to KITTI label .txt files
- Leverage static transformations (tf_static messages) to calculate object locations and orientations in the desired coordinate frame
- Generate timestamps.csv linking frame IDs to bag message timestamps, ensuring label and point cloud correspondence
- Tested on ROS2 bags generated by [drone_detector_sim](https://github.com/AntonioLuisGH/drone_detector_sim) simulation environment

## Package Structure

- `bag_to_velodyne.py`: Converts PointCloud2 messages to binary point cloud files and stores timestamps
- `bag_to_labels.py`: Converts Marker bounding box messages to KITTI label files, using static transforms and corresponding timestamps

## Usage

### 1. Export PointCloud2 to KITTI .bin and timestamps

```bash
ros2 run <your_package_name> bag_to_velodyne.py \
    --bag-path /path/to/bag.db3 \
    --output-path /path/to/output_dir \
    --topic /lidar/avia
```

- `--bag-path`: Path to the input ROS2 bag file
- `--output-path`: Output directory (will create velodyne/ and timestamps.csv)
- `--topic`: ROS2 topic publishing the PointCloud2 messages

### 2. Export bounding boxes to KITTI .txt labels

```bash
ros2 run <your_package_name> bag_to_labels.py \
    --bag-path /path/to/bag.db3 \
    --output-path /path/to/output_dir \
    --bbox-topic /drone_bbox \
    --tf-topic /tf_static
```

- `--bag-path`: Path to the input ROS2 bag file
- `--output-path`: Output directory (must match previous step)
- `--bbox-topic`: Topic publishing bounding box markers
- `--tf-topic`: Static transform topic, typically /tf_static

## Notes

- The output_path should be the same for both scripts to maintain timestamp/label alignment
- bag_to_labels.py expects timestamps.csv generated by bag_to_velodyne.py to exist

## Generated Files

- `velodyne/`: Contains frame-wise KITTI .bin files (point clouds)
- `timestamp.csv`: Maps frame_id to bag message nanosecond timestamp
- `label_2/`: Contains frame-wise KITTI label .txt files for 3D object detection

## Requirements

- Python 3.8+
- ROS2 Galactic or newer
- Dependencies: rclpy, rosbag2_py, sensor_msgs_py, tf_transformations, numpy, visualization_msgs, geometry_msgs, tf2_msgs

Install dependencies using pip (inside your virtual environment):

```bash
pip install numpy tf-transformations
# Other dependencies are part of ROS2 Python installations
```

## Troubleshooting

- **Topic not found error**: Confirm your topic names and inspect available topics in your bag file
- **No transform found**: Ensure the static transform between drone_world and lidar_link exists in /tf_static
- **Missing intensity fields**: Default intensity is used for point clouds

## Example Workflow

1. Record your autonomous vehicle session into a ROS2 bag with point clouds and annotation markers
2. Run bag_to_velodyne.py to extract and convert point clouds
3. Run bag_to_labels.py to extract and convert labels, producing KITTI-compatible annotations
4. Use outputs for training and evaluation in 3D deep learning frameworks
